dist: trusty
sudo: required

services:
- docker

env:
  global:
    - DOCKER_DIR="$HOME/.cache/docker"
    - NPM_CACHE="$HOME/.cache/npm"
    - GRADLE_CACHE="$HOME/.cache/gradle"
  matrix:
    - BUILD_SDK=true
    - BUILD_SDK=false

cache:
  directories:
  - $DOCKER_DIR
  - $NPM_CACHE
  - $GRADLE_CACHE

matrix:
  fast_finish: true
  allow_failures:
    - env: BUILD_SDK=true

before_install:
- sudo apt-get update
- sudo apt-get -y install docker-ce realpath
- docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASS

install: true

script:
- ./bin/travis-build.sh

after_success:
# Code coverage report for all master commits and all pull requests
- if [ "$TRAVIS_BRANCH" == "master" ] || [ "$TRAVIS_EVENT_TYPE" == "pull_request" ]; then
      bash <(curl -s https://codecov.io/bash) -c -X coveragepy -F python;
  fi

# Build swagger docs and push them to gh-pages
- if [ "$TRAVIS_EVENT_TYPE" == "push" ] || [ -n "$TRAVIS_TAG" ]; then
      git config --global user.email "travis@travis-ci.org";
      git config --global user.name "Travis CI";
      git config --global push.default simple;

      if [ "$TRAVIS_EVENT_TYPE" == "push" ]; then
          ./bin/push-docs.sh "$GIT_REMOTE" branches "$TRAVIS_BRANCH" "Travis Core Docs Build - $TRAVIS_BUILD_NUMBER";
      else
          ./bin/push-docs.sh "$GIT_REMOTE" tags "$TRAVIS_TAG" "Travis Core Docs Build - $TRAVIS_BUILD_NUMBER";
      fi
  fi

# Tag and push flywheel/core image (master >> :latest, tag >> :tag)
- if [ "$TRAVIS_BRANCH" == "master" ] && [ "$TRAVIS_EVENT_TYPE" == "push" ]; then
      docker tag core:dist flywheel/core:latest;
      docker push flywheel/core:latest;
  fi
- if [ -n "$TRAVIS_TAG" ]; then
      docker tag core:dist flywheel/core:$TRAVIS_TAG;
      docker push flywheel/core:$TRAVIS_TAG;
  fi

deploy:
  provider: gcs
  access_key_id: $GCS_ACCESS_KEY_ID
  secret_access_key: $GCS_SECRET_ACCESS_KEY
  bucket: sdk-test
  local-dir: dist
  skip_cleanup: true
  on:
    repo: flywheel-io/core
    all_branches: true
    condition: $BUILD_SDK = true
