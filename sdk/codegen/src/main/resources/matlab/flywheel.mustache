% Flywheel - Global namespace for API calls
%
% Flywheel Properties:
%    apiClient - The api client instance
{{#apiInfo}}
{{#apis}}
%    {{classVarName}}{{#operations}}{{#tag}} - {{description}}{{/tag}}{{/operations}}
{{/apis}}
{{/apiInfo}}
%
% Flywheel Methods:
{{#apiInfo}}
{{#apis}}
{{#operations}}
{{#operation}}
{{^vendorExtensions.x-sdk-download-url}}
%    {{operationId}}{{#summary}} - {{{.}}}{{/summary}}
{{/vendorExtensions.x-sdk-download-url}}
{{#vendorExtensions.x-sdk-download-url}}
%    {{.}}{{#summary}} - {{{.}}}{{/summary}}
{{/vendorExtensions.x-sdk-download-url}}
{{#description}}
%       {{{.}}}
{{/description}}
{{/operation}}
{{/operations}}
{{/apis}}
{{/apiInfo}}
classdef Flywheel < handle
    % NOTE: This file is auto generated by the swagger code generator program.
    % Do not edit the file manually.
    properties(Constant)
        SDK_VERSION = '{{packageVersion}}';
    end
    properties
        apiClient
        {{#apiInfo}}
        {{#apis}}
        {{classVarName}}
        {{/apis}}
        {{/apiInfo}}
    end
    methods
        function obj = Flywheel(apiKey, root, skipVersionCheck)
            obj.apiClient = {{packageName}}.ApiClient(apiKey);

            % Set root mode
            if exist('root', 'var') && root
                obj.apiClient.restClient.addDefaultParameter('root', 'true');
            end

            checkVersion = isempty(getenv('FLYWHEEL_SDK_SKIP_VERSION_CHECK'));
            if checkVersion && exist('skipVersionCheck', 'var') && skipVersionCheck
                checkVersion = false;
            end

            userAgent = sprintf('Flywheel SDK/%s (Matlab %s; %s)', {{packageName}}.Flywheel.SDK_VERSION, version, computer);
            obj.apiClient.restClient.setDefaultHeader('User-Agent', userAgent);

            {{#apiInfo}}
            {{#apis}}
            obj.{{classVarName}} = {{apiPackage}}.{{classname}}(obj.apiClient);
            {{/apis}}
            {{/apiInfo}}

            % Perform version check
            if checkVersion
                obj.apiClient.setVersionCheckFn(@() obj.performVersionCheck());
            end
        end
        {{#apiInfo}}
        {{#apis}}
        {{#operations}}
        {{#operation}}
        {{^vendorExtensions.x-sdk-download-url}}
        function [returnData, resp] = {{operationId}}(obj, varargin)
            [returnData, resp] = obj.{{classVarName}}.{{operationId}}(varargin{:});
        end
        {{/vendorExtensions.x-sdk-download-url}}
        {{! x-sdk-download-url is a special case where we need to construct and return a full url }}
        {{#vendorExtensions.x-sdk-download-url}}
        function [returnData, resp] = {{.}}(obj, varargin)
            [returnData, resp] = obj.{{classVarName}}.{{operationId}}(varargin{:}, 'ticket', true);
            if ~isempty(returnData)
                reqUrl = resp.getRequestUrl().toCharArray';
                {{! Url will look like: ".../files/filename.txt?ticket" so just append the equals. }}
                returnData = strcat(reqUrl, '=', returnData.ticket);
            end
        end
        {{/vendorExtensions.x-sdk-download-url}}
        {{/operation}}
        {{/operations}}
        {{/apis}}
        {{/apiInfo}}

{{>flywheel_methods}}

        function performVersionCheck(obj)
            sdkVer = obj.parseVersion({{packageName}}.Flywheel.SDK_VERSION);
            releaseVersion = '';
            try
                serverVersion = obj.defaultApi.getVersion();
                releaseVersion = serverVersion.release;
            catch ME
            end

            releaseVer = obj.parseVersion(releaseVersion);

            versionsMatch = false;
            if ~isempty(sdkVer) && ~isempty(releaseVer)
                versionsMatch = strcmp(sdkVer, releaseVer);
            end

            fprintf('Server API Version: %s\n', releaseVersion);
            fprintf('Client SDK Version: %s\n', {{packageName}}.Flywheel.SDK_VERSION);

            if ~versionsMatch
                warning('Flywheel:versionMismatch', 'Client and server versions do not match. This is an unsupported configuration!');
                if ~isempty(releaseVersion)
                    fprintf('Go to https://github.com/flywheel-io/core/releases to find a matching package for version: %s\n', releaseVersion);
                end
            end
        end
        function result = parseVersion(obj, s)
            if isempty(s)
                result = '';
            else
                parts = strsplit(s, '[^\d\.]+', 'DelimiterType', 'RegularExpression');
                semver = parts{1};
                parts = strsplit(semver, '.');
                result = sprintf('%s.%s', parts{1}, parts{2});
            end
        end
    end
end
